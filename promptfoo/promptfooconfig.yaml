# Promptfoo Configuration for Coding Assistant Testing
# This configuration tests the system-prompt.md against various scenarios

description: "Testing Coding Assistant scope enforcement and response quality"

# Prompts to test
prompts:
  - file://../coding-ai-agent/system-prompt.md

# Providers - configure your LLM
providers:
  - id: openai:gpt-4o-mini
    config:
      temperature: 0.1
      max_tokens: 1000

# Default test configuration
defaultTest:
  options:
    # Simulates the RAG context injection
    transformVars:
      knowledgeBase: |
        # Knowledge Base Context
        Available code modules:
        - BasicArithmetic.cs: Add, Subtract, Multiply, Divide methods
        - GeometryShapes.cs: Circle, Rectangle, Triangle calculations
        - NumberTheory.cs: IsPrime, GCD, LCM methods
        - FractionOperations.cs: Fraction arithmetic
        - PercentageCalculations.cs: Percentage operations

# Test cases organized by category
tests:
  # ========================================
  # Category 1: Valid KB Queries
  # ========================================
  
  - description: "Valid KB Query - BasicArithmetic.Add method"
    vars:
      query: "What does the Add method in BasicArithmetic do?"
      kb_results: |
        File: BasicArithmetic.cs
        Class: BasicArithmetic
        Method: Add(int a, int b)
        Code:
        ```csharp
        /// <summary>
        /// Adds two integers and returns the result.
        /// </summary>
        public static int Add(int a, int b)
        {
            return a + b;
        }
        ```
    assert:
      - type: contains
        value: "BasicArithmetic"
      - type: contains
        value: "Add"
      - type: not-contains
        value: "I don't have information"
      - type: not-contains
        value: "I cannot"

  - description: "Valid KB Query - GeometryShapes area calculation"
    vars:
      query: "How do I calculate the area of a circle?"
      kb_results: |
        File: GeometryShapes.cs
        Class: GeometryShapes
        Method: CircleArea(double radius)
        Code:
        ```csharp
        /// <summary>
        /// Calculates the area of a circle.
        /// </summary>
        public static double CircleArea(double radius)
        {
            return Math.PI * radius * radius;
        }
        ```
    assert:
      - type: contains
        value: "GeometryShapes"
      - type: contains-any
        value: ["CircleArea", "circle", "area"]
      - type: not-contains
        value: "I don't have information"

  - description: "Valid KB Query - Debugging request"
    vars:
      query: "Is there a bug in the IsPrime method?"
      kb_results: |
        File: NumberTheory.cs
        Class: NumberTheory
        Method: IsPrime(int n)
        Code:
        ```csharp
        public static bool IsPrime(int n)
        {
            if (n < 2) return false;
            for (int i = 2; i < n; i++)
            {
                if (n % i == 0) return false;
            }
            return true;
        }
        ```
    assert:
      - type: contains
        value: "NumberTheory"
      - type: contains
        value: "IsPrime"
      - type: not-contains
        value: "I don't have information"

  - description: "Valid KB Query - Code improvement suggestion"
    vars:
      query: "How can I improve the performance of the IsPrime method?"
      kb_results: |
        File: NumberTheory.cs
        Class: NumberTheory
        Method: IsPrime(int n)
        Code:
        ```csharp
        public static bool IsPrime(int n)
        {
            if (n < 2) return false;
            for (int i = 2; i < n; i++)
            {
                if (n % i == 0) return false;
            }
            return true;
        }
        ```
    assert:
      - type: contains-any
        value: ["improve", "optimiz", "performance", "faster"]
      - type: not-contains
        value: "I don't have information"

  # ========================================
  # Category 2: Invalid KB Queries
  # ========================================

  - description: "Invalid KB Query - Code not in knowledge base"
    vars:
      query: "How do I implement a binary search tree?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["don't have information", "not in my knowledge base", "specialize"]
      - type: contains-any
        value: ["C# mathematics library", "BasicArithmetic", "GeometryShapes"]
      - type: not-contains
        value: "class BinarySearchTree"

  - description: "Invalid KB Query - Different language"
    vars:
      query: "Explain Python decorators"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["don't have information", "not in my knowledge base"]
      - type: not-contains
        value: "@decorator"

  - description: "Invalid KB Query - External library"
    vars:
      query: "How do I use the React useState hook?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["don't have information", "not in my knowledge base", "C# mathematics library"]
      - type: not-contains
        value: "useState"

  - description: "Invalid KB Query - Code generation without KB pattern"
    vars:
      query: "Write me a REST API for user authentication"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["don't have information", "not in my knowledge base", "cannot"]

  # ========================================
  # Category 3: Off-Topic Queries
  # ========================================

  - description: "Off-Topic Query - Weather"
    vars:
      query: "What's the weather today?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["specialized coding assistant", "cannot answer general questions", "coding domain"]
      - type: not-contains
        value: "sunny"
      - type: not-contains
        value: "temperature"

  - description: "Off-Topic Query - Personal advice"
    vars:
      query: "What should I eat for dinner?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["specialized coding assistant", "cannot answer", "coding"]

  - description: "Off-Topic Query - General knowledge"
    vars:
      query: "Who won the World Cup in 2022?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["specialized coding assistant", "cannot answer", "coding domain"]

  - description: "Off-Topic Query - Math problem (not coding)"
    vars:
      query: "What is 25% of 80?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["specialized coding assistant", "code", "knowledge base"]

  # ========================================
  # Category 4: Edge Cases
  # ========================================

  - description: "Edge Case - Ambiguous query"
    vars:
      query: "Tell me about Add"
      kb_results: |
        File: BasicArithmetic.cs
        Class: BasicArithmetic
        Method: Add(int a, int b)
        Multiple matches found
    assert:
      - type: contains
        value: "Add"
      - type: not-contains
        value: "I don't have information"

  - description: "Edge Case - Very broad query"
    vars:
      query: "Tell me everything about the codebase"
      kb_results: |
        Multiple modules found:
        - BasicArithmetic.cs
        - GeometryShapes.cs
        - NumberTheory.cs
    assert:
      - type: contains-any
        value: ["BasicArithmetic", "GeometryShapes", "overview", "modules"]

  - description: "Edge Case - Multiple relevant results"
    vars:
      query: "What methods are available for calculations?"
      kb_results: |
        Multiple methods found:
        - BasicArithmetic.Add
        - BasicArithmetic.Subtract
        - GeometryShapes.CircleArea
        - PercentageCalculations.Calculate
    assert:
      - type: contains-any
        value: ["BasicArithmetic", "GeometryShapes", "methods"]
      - type: not-contains
        value: "I don't have information"

  # ========================================
  # Category 5: Response Quality Checks
  # ========================================

  - description: "Quality Check - Citation requirement"
    vars:
      query: "Explain the Add method"
      kb_results: |
        File: BasicArithmetic.cs
        Class: BasicArithmetic
        Method: Add
    assert:
      - type: contains
        value: "BasicArithmetic"
      - type: contains-any
        value: ["BasicArithmetic.cs", "file", "class"]

  - description: "Quality Check - No hallucination"
    vars:
      query: "Does the codebase have a neural network implementation?"
      kb_results: ""
    assert:
      - type: not-contains
        value: "neural network"
      - type: not-contains
        value: "class NeuralNetwork"
      - type: contains-any
        value: ["don't have information", "not in my knowledge base"]

  - description: "Quality Check - Scope adherence with similar topic"
    vars:
      query: "How do I implement quicksort?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["don't have information", "not in my knowledge base"]
      - type: not-contains
        value: "def quicksort"
      - type: not-contains
        value: "pivot"

  # ========================================
  # Category 6: Multi-Turn Simulation
  # ========================================

  - description: "Multi-Turn - Follow-up question on same topic"
    vars:
      query: "Earlier you explained Add. Now tell me about Subtract."
      kb_results: |
        File: BasicArithmetic.cs
        Class: BasicArithmetic
        Method: Subtract(int a, int b)
        Code:
        ```csharp
        public static int Subtract(int a, int b)
        {
            return a - b;
        }
        ```
    assert:
      - type: contains
        value: "Subtract"
      - type: contains
        value: "BasicArithmetic"
      - type: not-contains
        value: "I don't have information"

  - description: "Multi-Turn - Topic switch to off-topic"
    vars:
      query: "Thanks for explaining IsPrime. Now, what's the capital of France?"
      kb_results: ""
    assert:
      - type: contains-any
        value: ["specialized coding assistant", "cannot answer", "coding domain"]
      - type: not-contains
        value: "Paris"
